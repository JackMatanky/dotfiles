#!/usr/bin/env bash
{{/* vim: set filetype=bash: */}}
{{- if eq .chezmoi.os "linux" }}
# -----------------------------------------------------------------------------
# Script: run_onchange_upgrade-linux-packages.sh.tmpl
# Purpose: Upgrade Linux packages when package lists change
# Dependencies: Package managers (APT, Flatpak, Snap)
# Hash based on: {{ .packages.linux.flatpak | join "," }},{{ .packages.linux.apt | join "," }},{{ .packages.linux.snap | join "," }}
# -----------------------------------------------------------------------------

set -euo pipefail

{{ template "logging.sh" . }}

log_header "ðŸ”„ LINUX PACKAGE UPGRADES"

# Upgrade APT packages
if command -v apt &> /dev/null; then
    log_info "ðŸ”„ Updating APT packages..."
    if sudo apt update && sudo apt upgrade -y; then
        log_success "APT packages updated"
        
        # Clean up
        log_info "ðŸ§¹ Cleaning up APT..."
        sudo apt autoremove -y || log_warning "APT autoremove had issues"
        sudo apt autoclean || log_warning "APT autoclean had issues"
    else
        log_warning "APT upgrade had issues"
    fi
fi

# Upgrade Flatpak packages
if command -v flatpak &> /dev/null; then
    log_info "ðŸ”„ Updating Flatpak applications..."
    if flatpak update -y; then
        log_success "Flatpak applications updated"
    else
        log_warning "Flatpak update had issues"
    fi
fi

# Upgrade Snap packages
if command -v snap &> /dev/null; then
    log_info "ðŸ”„ Refreshing Snap packages..."
    if sudo snap refresh; then
        log_success "Snap packages refreshed"
    else
        log_warning "Snap refresh had issues"
    fi
fi

log_success "âœ… Linux package upgrades completed!"
{{- else }}
#!/usr/bin/env bash
# Not on Linux - skipping Linux package upgrades
exit 0
{{- end }}
