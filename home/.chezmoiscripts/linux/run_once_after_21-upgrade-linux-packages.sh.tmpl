#!/usr/bin/env bash
{{/* vim: set filetype=bash: */}}
{{- if eq .chezmoi.os "linux" }}
# -----------------------------------------------------------------------------
# Script: run_once_after_21-upgrade-linux-packages.sh.tmpl
# Purpose: Initial Linux package update and cleanup (runs once)
# When: Runs once after Linux packages are installed
# Dependencies: Package managers (APT, Flatpak, Snap)
# Note: For regular updates, use: sudo apt upgrade && flatpak update && sudo snap refresh
# -----------------------------------------------------------------------------

set -euo pipefail

{{ template "logging.sh" . }}

log_header "ðŸ“¦ LINUX INITIAL PACKAGE UPDATE"

# Only do upgrades on fresh install to avoid unexpected changes
if [[ ! -f "$HOME/.config/chezmoi-initial-setup-complete" ]]; then
    log_info "Initial setup detected - updating all package managers..."
    
    # Update APT packages
    if command -v apt &> /dev/null; then
        log_info "ðŸ”„ Updating APT packages..."
        if sudo apt update && sudo apt upgrade -y; then
            log_success "APT packages updated"
            
            # Clean up
            log_info "ðŸ§¹ Cleaning up APT..."
            sudo apt autoremove -y || log_warning "APT autoremove had issues"
            sudo apt autoclean || log_warning "APT autoclean had issues"
        else
            log_warning "APT upgrade had issues"
        fi
    fi
    
    # Update Flatpak packages
    if command -v flatpak &> /dev/null; then
        log_info "ðŸ”„ Updating Flatpak applications..."
        if flatpak update -y; then
            log_success "Flatpak applications updated"
        else
            log_warning "Flatpak update had issues"
        fi
    fi
    
    # Update Snap packages
    if command -v snap &> /dev/null; then
        log_info "ðŸ”„ Refreshing Snap packages..."
        if sudo snap refresh; then
            log_success "Snap packages refreshed"
        else
            log_warning "Snap refresh had issues"
        fi
    fi
else
    log_info "Existing setup detected - skipping package upgrades"
    log_info "To upgrade packages manually, run:"
    log_info "  â€¢ sudo apt update && sudo apt upgrade"
    log_info "  â€¢ flatpak update"
    log_info "  â€¢ sudo snap refresh"
fi

log_success "âœ… Linux package update completed!"
{{- else }}
#!/usr/bin/env bash
# Not on Linux - skipping Linux package upgrades
exit 0
{{- end }}
