#!/usr/bin/env bash
{{/* vim: set filetype=bash: */}}
{{- if eq .chezmoi.os "darwin" }}
# -----------------------------------------------------------------------------
# Script: run_onchange_upgrade-homebrew-packages.sh.tmpl
# Purpose: Upgrade Homebrew packages when package lists change
# Dependencies: Homebrew
# Hash based on: {{ .packages.darwin.taps | join "," }},{{ .packages.darwin.brews | join "," }},{{ .packages.darwin.casks | join "," }}
# -----------------------------------------------------------------------------

set -euo pipefail

{{ template "logging.sh" . }}

log_header "ðŸ”„ HOMEBREW PACKAGE UPGRADES"

# Ensure Homebrew is available
if ! command -v brew &> /dev/null; then
    log_error "Homebrew not found. Please run the Homebrew setup script first."
    exit 1
fi

log_info "Updating Homebrew and upgrading packages..."

# Update Homebrew
if brew update; then
    log_success "Homebrew updated"
else
    log_warning "Homebrew update had issues"
fi

# Upgrade all packages
if brew upgrade; then
    log_success "All packages upgraded"
else
    log_warning "Some packages failed to upgrade"
fi

# Clean up old versions
log_info "ðŸ§¹ Cleaning up old versions..."
brew cleanup --prune=all || log_warning "Cleanup had issues"

log_success "âœ… Homebrew package upgrades completed!"
{{- end }}
