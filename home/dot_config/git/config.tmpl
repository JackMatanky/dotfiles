#------------------------------------------------------------------------------#
# Filename: ~/.config/git/config (managed by chezmoi)
# Git Docs: https://git-scm.com/docs/git-config
# Delta Docs: https://dandavison.github.io/delta
# Enhanced with chezmoi templating for cross-platform compatibility
#------------------------------------------------------------------------------#

[user]
    name = {{ .name }}
    email = {{ .email }}
    {{- if .dev.use_gpg }}
    signingkey = {{ .gpg.key_id | default "your-gpg-key-id" }}
    {{- end }}

[init]
    defaultBranch = main

[pull]
    rebase = false

[push]
    default = simple
    {{- if .dev.use_gpg }}
    gpgSign = if-asked
    {{- end }}

{{- if .dev.use_gpg }}
[commit]
    gpgSign = true

[tag]
    gpgSign = true
{{- end }}

[core]
    # Convert CRLF to LF on input
    autocrlf = input
    
    # Use LF as the end-of-line character
    eol = lf
    
    # Use delta for all core Git paging (diff/log/etc.)
    pager = delta
    
    # Global config files for Git attributes and ignores
    attributesfile = ~/.config/git/.gitattributes
    excludesfile = ~/.config/git/.gitignore_global
    
    # Editor preference from chezmoi data
    {{- if eq .preferences.editor "zed" }}
    editor = zed --wait
    {{- else if eq .preferences.editor "nvim" }}
    editor = nvim
    {{- else if eq .preferences.editor "helix" }}
    editor = hx
    {{- else }}
    editor = {{ .preferences.editor | default "vim" }}
    {{- end }}

[credential]
    {{- if eq .chezmoi.os "darwin" }}
    # Use macOS Keychain for credential storage
    helper = osxkeychain
    {{- else if eq .chezmoi.os "linux" }}
    # Use libsecret for credential storage on Linux
    helper = /usr/share/doc/git/contrib/credential/libsecret/git-credential-libsecret
    {{- end }}

[diff]
    # Use delta as the default diff tool
    tool = delta
    colorMoved = default

[difftool "delta"]
    cmd = delta "$LOCAL" "$REMOTE"

[merge]
    # Tool preference from chezmoi data
    {{- if eq .preferences.editor "zed" }}
    tool = zed
    {{- else if eq .preferences.editor "nvim" }}
    tool = nvimdiff
    {{- else }}
    tool = vimdiff
    {{- end }}
    conflictstyle = diff3

{{- if eq .preferences.editor "zed" }}
[mergetool "zed"]
    cmd = zed --wait --merge "$REMOTE" "$LOCAL" "$BASE" "$MERGED"
{{- else if eq .preferences.editor "nvim" }}
[mergetool "nvimdiff"]
    cmd = nvim -d "$LOCAL" "$REMOTE" "$MERGED" -c '$wincmd w' -c 'wincmd J'
{{- end }}

[delta]
    # Theme based on user preference
    {{- if eq .theme.colorscheme "catppuccin_latte" }}
    syntax-theme = "Catppuccin-latte"
    {{- else if eq .theme.colorscheme "catppuccin_macchiato" }}
    syntax-theme = "Catppuccin-macchiato"
    {{- else }}
    syntax-theme = "base16"
    {{- end }}
    
    navigate = true
    light = {{ if eq .theme.colorscheme "catppuccin_latte" }}true{{ else }}false{{ end }}
    side-by-side = false
    line-numbers = true
    decorations = true
    file-style = bold yellow ul
    file-decoration-style = none
    hunk-header-decoration-style = cyan box ul

[interactive]
    diffFilter = delta --color-only

[add.interactive]
    useBuiltin = false # required for git 2.37.0

# Platform-specific configurations
{{- if eq .chezmoi.os "darwin" }}
[core]
    # Prevent .DS_Store files in repositories
    excludesfile = ~/.config/git/.gitignore_global

[url "https://github.com/"]
    insteadOf = git://github.com/
{{- end }}

# Development workflow aliases
[alias]
    # Short status
    st = status --short --branch
    
    # Pretty log
    lg = log --graph --pretty=format:'%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)<%an>%Creset' --abbrev-commit --all
    
    # Current branch
    cb = symbolic-ref --short HEAD
    
    # Branch management
    co = checkout
    br = branch
    ci = commit
    
    # Push current branch
    pushcb = "!git push origin $(git cb)"
    
    # Pull with rebase
    pr = pull --rebase
    
    # Undo last commit (soft)
    undo = reset --soft HEAD~1
    
    # Show files in last commit
    dl = "!git ll -1"
    
    # Diff last commit
    dlc = diff --cached HEAD^
    
    # List aliases
    la = "!git config -l | grep alias | cut -c 7-"

# Work-specific configuration (if work email is configured)
{{- if .work }}
{{- if .work.email }}
[includeIf "gitdir:{{ .work.directory | default "~/work/" }}"]
    path = ~/.config/git/config_work
{{- end }}
{{- end }}

# URL rewrites for common Git hosting
[url "git@github.com:"]
    insteadOf = https://github.com/

[url "git@gitlab.com:"]
    insteadOf = https://gitlab.com/

# Performance optimizations
[core]
    preloadindex = true
    fscache = true

[gc]
    auto = 256

[pack]
    threads = 0
