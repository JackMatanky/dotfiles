# vim: filetype=zsh
# shellcheck shell=zsh

# -----------------------------------------------------------------------------
# Filename: ~/.zprofile
# Description: Zsh login shell configuration for macOS and Linux.
#              Sources .zshrc, initializes SSH agent via keychain, and exports
#              SSH_AUTH_SOCK to GUI apps on macOS.
# Template Variables:
#   - .chezmoi.os: Operating system ("darwin" or "linux")
#   - .chezmoi.homeDir: User's home directory
#   - .paths.brew_prefix: Homebrew installation prefix
# -----------------------------------------------------------------------------

# Require HOME; exit with error if unset/empty
: "${HOME:?HOME must be set}"

# ---------------------- Source .zshrc ---------------------- #
# Load interactive shell configuration
readonly ZSHRC="{{ .chezmoi.homeDir }}/.zshrc"
# shellcheck source=/dev/null
[[ -f "$ZSHRC" ]] && source "$ZSHRC"

# ----------------- Keychain SSH Agent Setup ----------------- #
# Initialize SSH agent via keychain for secure key management
readonly SSH_KEY="{{ .chezmoi.homeDir }}/.ssh/id_ed25519"
if [[ -f "$SSH_KEY" ]] && command -v keychain >/dev/null 2>&1; then
  eval "$(keychain --eval --quiet --nogui "$SSH_KEY")"
fi

{{- if eq .chezmoi.os "darwin" }}
# ------- Export SSH_AUTH_SOCK to GUI Apps (macOS Only) ------ #
# Make SSH agent available to GUI applications via launchd
if [[ -n "${SSH_AUTH_SOCK:-}" ]]; then
  launchctl setenv SSH_AUTH_SOCK "$SSH_AUTH_SOCK"
fi
{{- end }}
